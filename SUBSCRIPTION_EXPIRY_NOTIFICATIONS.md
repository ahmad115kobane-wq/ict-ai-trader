# ูุธุงู ุฅุดุนุงุฑุงุช ุงูุชูุงุก ุงูุงุดุชุฑุงู
## Subscription Expiry Notification System

ุชู ุชูุนูู ูุธุงู ุฅุดุนุงุฑุงุช ุงูุชูุงุก ุงูุงุดุชุฑุงู ุจุงููุงูู โ

---

## ๐ ุงูููุฒุงุช

### 1. ุฅุดุนุงุฑ ุงูุชูุงุก ุงูุงุดุชุฑุงู
- **ูุชู**: ุนูุฏ ุงูุชูุงุก ุตูุงุญูุฉ ุงูุงุดุชุฑุงู
- **ุงูุฑุณุงูุฉ**: "โ๏ธ ุงูุชูู ุงุดุชุฑุงูู - ููุฏ ุงูุชูู ุงุดุชุฑุงูู ูู ุจุงูุฉ [ุงุณู ุงูุจุงูุฉ]. ูู ุจุชุฌุฏูุฏ ุงุดุชุฑุงูู ููุงุณุชูุฑุงุฑ ูู ุงูุญุตูู ุนูู ุงูุชุญูููุงุช ุงูุชููุงุฆูุฉ."
- **ุงูุฃููููุฉ**: ุนุงููุฉ (high)
- **ุงูุฅุฌุฑุงุก**: ูุชู ุฅููุงู ุงูุชุญููู ุงูุชููุงุฆู ุชููุงุฆูุงู

### 2. ุฅุดุนุงุฑ ูุฑุจ ุงูุชูุงุก ุงูุงุดุชุฑุงู
- **ูุชู**: ูุจู 3 ุฃูุงู ูู ุงูุชูุงุก ุงูุงุดุชุฑุงู
- **ุงูุฑุณุงูุฉ**: "โฐ ุงุดุชุฑุงูู ุนูู ูุดู ุงูุงูุชูุงุก - ุณููุชูู ุงุดุชุฑุงูู ูู ุจุงูุฉ [ุงุณู ุงูุจุงูุฉ] ุฎูุงู [X] ุฃูุงู. ุฌุฏุฏ ุงูุขู ูุชุฌูุจ ุงููุทุงุน ุงูุฎุฏูุฉ."
- **ุงูุฃููููุฉ**: ุนุงุฏูุฉ (normal)

### 3. ุฅุดุนุงุฑ ุดุฑุงุก ุงุดุชุฑุงู ุฌุฏูุฏ
- **ูุชู**: ุนูุฏ ุดุฑุงุก ุงุดุชุฑุงู ุฌุฏูุฏ ุจูุฌุงุญ
- **ุงูุฑุณุงูุฉ**: "๐ ุชู ุชูุนูู ุงุดุชุฑุงูู - ุชู ุชูุนูู ุงุดุชุฑุงูู ูู ุจุงูุฉ [ุงุณู ุงูุจุงูุฉ] ุจูุฌุงุญ! ุตุงูุญ ุญุชู [ุชุงุฑูุฎ ุงูุงูุชูุงุก]"
- **ุงูุฃููููุฉ**: ุนุงููุฉ (high)

---

## ๐ ุขููุฉ ุงูุนูู

### ุงููุญุต ุงูุฏูุฑู
ูุชู ูุญุต ุงูุงุดุชุฑุงูุงุช ุจุดูู ุฏูุฑู ูู 6 ุณุงุนุงุช:

```javascript
// ูู server/src/index.ts
cron.schedule('0 */6 * * *', async () => {
  await checkSubscriptionExpirations();
});
```

### ุนูุฏ ุจุฏุก ุงูุชุดุบูู
ูุชู ูุญุต ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ ุนูุฏ ุจุฏุก ุชุดุบูู ุงูุฎุงุฏู:

```javascript
const initialCheck = await checkAndExpireSubscriptions();
```

---

## ๐ฑ ูููุงุช ุงูุฅุฑุณุงู

### 1. ุงูุชุทุจูู (Push Notifications)
- ูุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุฅูู ุงูุชุทุจูู ุนุจุฑ Firebase/Expo Push
- ูุธูุฑ ูู ุดุงุดุฉ ุงูุฅุดุนุงุฑุงุช ุฏุงุฎู ุงูุชุทุจูู
- ููุญูุธ ูู ุฌุฏูู `system_notifications`

### 2. ุงูุชููุฌุฑุงู
- ูุชู ุฅุฑุณุงู ุฑุณุงูุฉ ูุจุงุดุฑุฉ ูููุณุชุฎุฏููู ุงููุณุฌููู ุนุจุฑ ุงูุชููุฌุฑุงู
- ุชุญุชูู ุนูู ููุณ ุงููุนูููุงุช ูุงูุชูุณูู

---

## ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุฌุฏูู system_notifications
```sql
CREATE TABLE system_notifications (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  type TEXT NOT NULL,  -- 'subscription_expired', 'subscription_expiring', etc.
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  priority TEXT NOT NULL,  -- 'high', 'normal', 'low'
  data JSONB,
  read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### ุฃุนูุฏุฉ ุฌุฏูุฏุฉ ูู ุฌุฏูู users
```sql
ALTER TABLE users ADD COLUMN subscription_expiry_notified BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN subscription_expiring_notified BOOLEAN DEFAULT FALSE;
```

ูุฐู ุงูุฃุนูุฏุฉ ุชููุน ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุฃูุซุฑ ูู ูุฑุฉ ูููุณุชุฎุฏู ููุณู.

---

## ๐ง ุงููููุงุช ุงููุนุฏูุฉ

### 1. `server/src/services/subscriptionService.ts`
- ุฅุถุงูุฉ ุงุณุชุฏุนุงุก `notifySubscriptionExpired` ูู ุฏุงูุฉ `checkAndExpireSubscriptions`
- ูุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุนูุฏ ุงูุชูุงุก ูู ุงุดุชุฑุงู

### 2. `server/src/services/systemNotificationService.ts`
- ุฏุงูุฉ `notifySubscriptionExpired`: ุฅุฑุณุงู ุฅุดุนุงุฑ ุงูุชูุงุก ุงูุงุดุชุฑุงู
- ุฏุงูุฉ `notifySubscriptionExpiring`: ุฅุฑุณุงู ุฅุดุนุงุฑ ูุฑุจ ุงูุงูุชูุงุก (3 ุฃูุงู)
- ุฏุงูุฉ `notifySubscriptionPurchased`: ุฅุฑุณุงู ุฅุดุนุงุฑ ุดุฑุงุก ุฌุฏูุฏ
- ุฏุงูุฉ `checkSubscriptionExpirations`: ูุญุต ุฏูุฑู ููุงุดุชุฑุงูุงุช

### 3. `server/src/db/postgresAdapter.ts`
- ุฅุถุงูุฉ ุฃุนูุฏุฉ `subscription_expiry_notified` ู `subscription_expiring_notified`
- ูุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ุนูุฏ ุจุฏุก ุงูุชุดุบูู ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ

---

## โ ุงูุชุญูู ูู ุนูู ุงููุธุงู

### 1. ูุญุต ูุฏูู
ููููู ูุญุต ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ ูุฏููุงู ุนุจุฑ:
```
GET /check-expired-subscriptions
```

### 2. ูุฑุงูุจุฉ ุงูุณุฌูุงุช (Logs)
ุงุจุญุซ ุนู ูุฐู ุงูุฑุณุงุฆู ูู ุงูุณุฌูุงุช:
- `๐ Checking for expired subscriptions...`
- `๐ง Sent expiry notification to user [user_id]`
- `โ Processed X expired subscriptions`

### 3. ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
```sql
-- ุนุฑุถ ุงูุฅุดุนุงุฑุงุช ุงููุฑุณูุฉ
SELECT * FROM system_notifications 
WHERE type = 'subscription_expired' 
ORDER BY created_at DESC;

-- ุนุฑุถ ุงููุณุชุฎุฏููู ุงูุฐูู ุชู ุฅุดุนุงุฑูู
SELECT id, email, subscription, subscription_expiry, subscription_expiry_notified
FROM users 
WHERE subscription_expiry_notified = true;
```

---

## ๐ฏ ุณููุงุฑูู ุงูุงุณุชุฎุฏุงู

### ูุซุงู: ูุณุชุฎุฏู ุงุดุชุฑุงูู ููุชูู ุจุนุฏ ููููู

1. **ุงูููู 1** (ูุจู 3 ุฃูุงู):
   - ูุชููู ุฅุดุนุงุฑ: "โฐ ุงุดุชุฑุงูู ุนูู ูุดู ุงูุงูุชูุงุก ุฎูุงู 3 ุฃูุงู"
   - ููุนููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: `subscription_expiring_notified = true`

2. **ุงูููู 3** (ููู ุงูุงูุชูุงุก):
   - ูุชููู ุฅุดุนุงุฑ: "โ๏ธ ุงูุชูู ุงุดุชุฑุงูู"
   - ููุนููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: `subscription_expiry_notified = true`
   - ูุชู ุฅููุงู ุงูุชุญููู ุงูุชููุงุฆู: `auto_analysis_enabled = false`

3. **ุจุนุฏ ุงูุชุฌุฏูุฏ**:
   - ุนูุฏ ุดุฑุงุก ุงุดุชุฑุงู ุฌุฏูุฏุ ูุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุฃุนูุฏุฉ:
     - `subscription_expiry_notified = false`
     - `subscription_expiring_notified = false`
   - ูุชููู ุฅุดุนุงุฑ: "๐ ุชู ุชูุนูู ุงุดุชุฑุงูู"

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

ููููู ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช ุงูุฅุดุนุงุฑุงุช:

```sql
-- ุนุฏุฏ ุงูุฅุดุนุงุฑุงุช ุงููุฑุณูุฉ ุงูููู
SELECT COUNT(*) FROM system_notifications 
WHERE type = 'subscription_expired' 
AND created_at >= CURRENT_DATE;

-- ุงููุณุชุฎุฏููู ุงูุฐูู ูู ููุฑุฃูุง ุงูุฅุดุนุงุฑุงุช
SELECT COUNT(*) FROM system_notifications 
WHERE type = 'subscription_expired' 
AND read = false;
```

---

## ๐ ุงูุฃูุงู

- ุงูุฅุดุนุงุฑุงุช ุชูุฑุณู ููุท ูููุณุชุฎุฏู ุงููุนูู
- ูุง ูุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุฃูุซุฑ ูู ูุฑุฉ (ุจุงุณุชุฎุฏุงู ุงูุฃุนูุฏุฉ `_notified`)
- ุฌููุน ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ ูุญููุฉ

---

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

ูููู ุฅุถุงูุฉ:
- ุฅุดุนุงุฑ ูุจู ุฃุณุจูุน ูู ุงูุงูุชูุงุก
- ุฅุดุนุงุฑ ุจุนุฏ ุงูุชูุงุก ุงูุงุดุชุฑุงู ุจููู (ุชุฐููุฑ)
- ุฅุดุนุงุฑุงุช ุนุฑูุถ ุฎุงุตุฉ ููุชุฌุฏูุฏ
- ุฅุญุตุงุฆูุงุช ููุตูุฉ ุนู ูุนุฏูุงุช ุงูุชุฌุฏูุฏ

---

## ๐ ููุงุญุธุงุช

- ุงููุธุงู ูุนูู ุชููุงุฆูุงู ุจุฏูู ุชุฏุฎู ูุฏูู
- ุงูุฅุดุนุงุฑุงุช ุชูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุฑุฌูุน ุฅูููุง
- ูููู ูููุณุชุฎุฏู ุนุฑุถ ุฌููุน ุฅุดุนุงุฑุงุชู ูู ุงูุชุทุจูู
- ุงูุชููุฌุฑุงู ูุงูุชุทุจูู ูุณุชููุงู ููุณ ุงูุฅุดุนุงุฑุงุช

---

โ **ุงููุธุงู ุฌุงูุฒ ููุนูู ุจุดูู ูุงูู!**
