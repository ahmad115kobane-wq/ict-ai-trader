<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ Ù†Ø¸Ø§Ù… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„ - Backtesting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .card-header { background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white; border-radius: 15px 15px 0 0 !important; font-weight: bold; }
        .btn-primary { background: linear-gradient(45deg, #0d6efd, #0a58ca); border: none; }
        .stat-card { text-align: center; padding: 20px; background: white; border-radius: 10px; margin-bottom: 15px; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 24px; font-weight: bold; color: #0d6efd; }
        .stat-label { color: #6c757d; font-size: 14px; }
        .win { color: #198754; }
        .loss { color: #dc3545; }
        #logs { max-height: 300px; overflow-y: auto; background: #212529; color: #00ff00; font-family: monospace; padding: 15px; border-radius: 10px; direction: ltr; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1>ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª AI</h1>
            <p class="text-muted">Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„ ÙˆØ§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©</p>
        </div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="row justify-content-center">
        <div class="col-md-6">
            <div class="card p-4">
                <h4 class="mb-3">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</h4>
                <div class="mb-3">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="email" class="form-control" placeholder="admin@example.com">
                </div>
                <div class="mb-3">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" class="form-control" placeholder="********">
                </div>
                <button onclick="login()" class="btn btn-primary w-100">Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Section (Hidden by default) -->
    <div id="dashboardSection" style="display: none;">
        <div class="row">
            <!-- Controls -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label>Ø§Ù„Ø²ÙˆØ¬ (Symbol)</label>
                            <select id="symbol" class="form-select">
                                <option value="XAUUSD">XAUUSD (Ø§Ù„Ø°Ù‡Ø¨)</option>
                                <option value="EURUSD">EURUSD</option>
                                <option value="GBPUSD">GBPUSD</option>
                                <option value="BTCUSD">BTCUSD</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                            <select id="testType" class="form-select" onchange="toggleDates()">
                                <option value="quick">âš¡ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</option>
                                <option value="custom">ğŸ“… ÙØªØ±Ø© Ù…Ø®ØµØµØ©</option>
                                <option value="demo">ğŸ® ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø¨Ø¯ÙˆÙ† AI)</option>
                            </select>
                        </div>

                        <div id="dateInputs" style="display: none;">
                            <div class="mb-3">
                                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="useAI" checked>
                            <label class="form-check-label">Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ­Ù„ÙŠÙ„ AI (Ø£Ø¨Ø·Ø£ ÙˆØ£Ø¯Ù‚)</label>
                        </div>

                        <button onclick="runBacktest()" id="runBtn" class="btn btn-primary w-100 py-2">
                            â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                    <div class="card-body p-0">
                        <div id="logs">
                            > Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="col-md-8">
                <!-- Summary Stats -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value" id="totalTrades">-</div>
                            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value win" id="winRate">-</div>
                            <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value" id="netProfit">-</div>
                            <div class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Pips)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value" id="profitFactor">-</div>
                            <div class="stat-label">Profit Factor</div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="card">
                    <div class="card-header">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="outcomesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Metrics -->
                <div class="card">
                    <div class="card-header">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</div>
                    <div class="card-body" id="detailedMetrics">
                        <p class="text-center text-muted">Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let token = localStorage.getItem('authToken');
    let outcomesChart = null;

    // Check login
    if (token) {
        showDashboard();
    }

    function showDashboard() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('dashboardSection').style.display = 'block';
    }

    async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        try {
            log('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            
            if (data.token) {
                token = data.token;
                localStorage.setItem('authToken', token);
                log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                showDashboard();
            } else {
                alert('ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + e.message);
        }
    }

    function toggleDates() {
        const type = document.getElementById('testType').value;
        document.getElementById('dateInputs').style.display = type === 'custom' ? 'block' : 'none';
    }

    function log(msg) {
        const logs = document.getElementById('logs');
        const time = new Date().toLocaleTimeString('ar-SA');
        logs.innerHTML += `<div><span class="text-muted">[${time}]</span> ${msg}</div>`;
        logs.scrollTop = logs.scrollHeight;
    }

    async function runBacktest() {
        const type = document.getElementById('testType').value;
        const symbol = document.getElementById('symbol').value;
        const useAI = document.getElementById('useAI').checked;
        const btn = document.getElementById('runBtn');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...';
        log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...');

        let endpoint = '/api/backtesting/run';
        let body = { symbol, useAI, saveToDatabase: true };

        if (type === 'quick') {
            endpoint = '/api/backtesting/quick-test';
        } else if (type === 'demo') {
            endpoint = '/api/backtesting/demo';
        } else {
            body.startDate = document.getElementById('startDate').value;
            body.endDate = document.getElementById('endDate').value;
            if (!body.startDate || !body.endDate) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®');
                btn.disabled = false;
                btn.innerHTML = 'â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
                return;
            }
        }

        try {
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(body)
            });
            
            const data = await res.json();
            
            if (data.success) {
                log('âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!');
                displayResults(data.result);
            } else {
                log('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + data.error);
                if (data.details) log(data.details);
            }
        } catch (e) {
            log('ğŸ”¥ Ø®Ø·Ø£ ÙØ§Ø¯Ø­: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
        }
    }

    function displayResults(result) {
        const stats = result.statistics;
        const metrics = result.metrics || {}; // Fallback if metrics missing

        // Update Top Cards
        document.getElementById('totalTrades').innerText = stats.tradesExecuted;
        document.getElementById('winRate').innerText = stats.winRate.toFixed(1) + '%';
        document.getElementById('winRate').className = 'stat-value ' + (stats.winRate > 50 ? 'win' : 'loss');
        document.getElementById('netProfit').innerText = stats.totalProfit.toFixed(1);
        document.getElementById('netProfit').className = 'stat-value ' + (stats.totalProfit > 0 ? 'win' : 'loss');
        document.getElementById('profitFactor').innerText = (stats.profitFactor || metrics.profitFactor || 0).toFixed(2);

        // Update Chart
        if (outcomesChart) outcomesChart.destroy();
        const ctx = document.getElementById('outcomesChart').getContext('2d');
        outcomesChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['TP1', 'TP2', 'TP3', 'SL', 'Expired'],
                datasets: [{
                    data: [
                        stats.outcomes.TP1,
                        stats.outcomes.TP2,
                        stats.outcomes.TP3,
                        stats.outcomes.SL,
                        stats.outcomes.EXPIRED
                    ],
                    backgroundColor: ['#198754', '#20c997', '#0dcaf0', '#dc3545', '#6c757d']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // Detailed Metrics HTML
        let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <tbody>
                        <tr><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</td><td>${stats.totalAnalyses}</td></tr>
                        <tr><td>ØµÙÙ‚Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©</td><td>${stats.tradesGenerated}</td></tr>
                        <tr><td>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø¨Ø­</td><td>${stats.avgProfit.toFixed(1)} Pips</td></tr>
                        <tr><td>Ù…ØªÙˆØ³Ø· Ù…Ø¯Ø© Ø§Ù„ØµÙÙ‚Ø©</td><td>${stats.avgDuration.toFixed(1)} Ø³Ø§Ø¹Ø©</td></tr>
                        <tr><td>Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø© Ø±Ø¨Ø­</td><td>${metrics.longestWinStreak || '-'}</td></tr>
                        <tr><td>Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø© Ø®Ø³Ø§Ø±Ø©</td><td>${metrics.longestLossStreak || '-'}</td></tr>
                    </tbody>
                </table>
            </div>
            <h6 class="mt-3">Ø§Ù„ØªÙˆØµÙŠØ§Øª:</h6>
            <div class="alert alert-info">
                ${(result.recommendations || 'Ù†ØªØ§Ø¦Ø¬ Ø¬ÙŠØ¯Ø©! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ­Ø³ÙŠÙ†.').replace(/\n/g, '<br>')}
            </div>
        `;
        document.getElementById('detailedMetrics').innerHTML = html;
        log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ“Š');
    }
</script>
</body>
</html>
