# منع الشراء المتكرر والسماح بالترقية

## القاعدة الجديدة

**لا يمكن شراء باقة جديدة إذا كان لديك اشتراك نشط، إلا إذا كنت تريد الترقية من الشهري إلى السنوي.**

## المنطق المطبق

### 1. التحقق من الاشتراك النشط ✅

```typescript
const subscriptionStatus = await getUserSubscriptionStatus(userId);

if (subscriptionStatus.hasActiveSubscription && subscriptionStatus.subscription) {
  // لديه اشتراك نشط - التحقق من إمكانية الترقية
}
```

### 2. تحديد مدة الاشتراك الحالي ✅

```typescript
const currentDuration = currentSubscription.plan_name.includes('شهر') ? 30 : 
                       currentSubscription.plan_name.includes('أسبوع') ? 7 : 365;
const newDuration = packageDetails.durationDays;
```

### 3. السماح بالترقية فقط من شهري إلى سنوي ✅

```typescript
const isUpgrade = currentDuration === 30 && newDuration === 365;

if (!isUpgrade) {
  return error: "لديك اشتراك نشط بالفعل. لا يمكنك شراء باقة جديدة إلا إذا كنت تريد الترقية من الباقة الشهرية إلى السنوية."
}
```

## الحالات المسموحة

| الاشتراك الحالي | الباقة الجديدة | النتيجة |
|-----------------|----------------|---------|
| لا يوجد | أي باقة | ✅ مسموح |
| أسبوعي | أي باقة | ❌ ممنوع |
| شهري | سنوي | ✅ مسموح (ترقية) |
| شهري | أسبوعي | ❌ ممنوع |
| شهري | شهري | ❌ ممنوع |
| سنوي | أي باقة | ❌ ممنوع |

## رسالة الخطأ

عند محاولة الشراء مع وجود اشتراك نشط (بدون ترقية):

```json
{
  "success": false,
  "error": "لديك اشتراك نشط بالفعل (الباقة الشهرية). لا يمكنك شراء باقة جديدة إلا إذا كنت تريد الترقية من الباقة الشهرية إلى السنوية.",
  "currentSubscription": {
    "name": "الباقة الشهرية",
    "expiresAt": "2024-02-15"
  },
  "canUpgrade": true
}
```

## الفوائد

1. ✅ منع الشراء المتكرر والهدر
2. ✅ السماح بالترقية للباقات الأفضل
3. ✅ حماية رصيد المستخدم
4. ✅ رسائل واضحة ومفيدة
5. ✅ تشجيع الترقية للباقة السنوية

## الملفات المعدلة

- `server/src/routes/subscription.ts`
  - إضافة التحقق من الاشتراك النشط
  - إضافة منطق الترقية
  - رسائل خطأ واضحة
