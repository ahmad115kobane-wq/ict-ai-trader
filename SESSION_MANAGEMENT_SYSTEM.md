# ูุธุงู ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช - ุฌูุณุฉ ูุงุญุฏุฉ ูุดุทุฉ ููุท โ

## ุงููุตู
ูุธุงู ุฌูุณุงุช ูุชูุฏู ูุณูุญ ุจุฌูุณุฉ ูุงุญุฏุฉ ูุดุทุฉ ููุท ููู ูุณุชุฎุฏู. ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ูู ุฌูุงุฒ ุฌุฏูุฏุ ูุชู ุฅููุงุก ุงูุฌูุณุฉ ุงููุฏููุฉ ุชููุงุฆูุงู.

## ุงูููุฒุงุช

### 1. ุฌูุณุฉ ูุงุญุฏุฉ ูุดุทุฉ ููุท
- ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ูู ุฌูุงุฒ ุฌุฏูุฏุ ูุชู ุฅููุงุก ุฌููุน ุงูุฌูุณุงุช ุงููุฏููุฉ ุชููุงุฆูุงู
- ูุง ูููู ุงุณุชุฎุฏุงู ููุณ ุงูุญุณุงุจ ูู ุฃูุซุฑ ูู ุฌูุงุฒ ูู ููุณ ุงูููุช
- ุงูุฌูุณุฉ ุงูุฃุญุฏุซ ูู ุงููุญูุฏุฉ ุงููุดุทุฉ

### 2. ุชุชุจุน ูุนูููุงุช ุงูุฌูุณุฉ
- ููุน ุงูุฌูุงุฒ (Mobile/Tablet/Desktop)
- ุนููุงู IP
- ููุช ุงูุฅูุดุงุก
- ุขุฎุฑ ูุดุงุท
- ุชุงุฑูุฎ ุงูุชูุงุก ุงูุตูุงุญูุฉ (30 ููู)

### 3. ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช
- ุนุฑุถ ุงูุฌูุณุงุช ุงููุดุทุฉ
- ุชุณุฌูู ุงูุฎุฑูุฌ (ุฅููุงุก ุงูุฌูุณุฉ ุงูุญุงููุฉ)
- ุฅููุงุก ุฌููุน ุงูุฌูุณุงุช ุงูุฃุฎุฑู
- ุชูุธูู ุชููุงุฆู ููุฌูุณุงุช ุงูููุชููุฉ

## ุงูุชุบููุฑุงุช ุงูุชูููุฉ

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช (`server/src/db/database.ts`)

#### ุฌุฏูู ุฌุฏูุฏ: `sessions`
```sql
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  token TEXT NOT NULL UNIQUE,
  device_info TEXT,
  ip_address TEXT,
  is_active BOOLEAN DEFAULT 1,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  last_activity TEXT DEFAULT CURRENT_TIMESTAMP,
  expires_at TEXT NOT NULL
)
```

#### ุฏูุงู ุฌุฏูุฏุฉ:
- `createSession()` - ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ ูุฅููุงุก ุงููุฏููุฉ
- `validateSession()` - ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุฌูุณุฉ
- `terminateSession()` - ุฅููุงุก ุฌูุณุฉ ูุญุฏุฏุฉ
- `terminateAllUserSessions()` - ุฅููุงุก ุฌููุน ุฌูุณุงุช ุงููุณุชุฎุฏู
- `getUserActiveSessions()` - ุงูุญุตูู ุนูู ุงูุฌูุณุงุช ุงููุดุทุฉ
- `cleanupExpiredSessions()` - ุชูุธูู ุงูุฌูุณุงุช ุงูููุชููุฉ

### 2. Middleware ุงููุตุงุฏูุฉ (`server/src/middleware/auth.ts`)

#### ุงูุชุญูู ูู ุงูุฌูุณุฉ
```typescript
// ุงูุชุญูู ูู JWT
const decoded = jwt.verify(token, JWT_SECRET);

// ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุฌูุณุฉ
const sessionValidation = validateSession(token);

if (!sessionValidation.valid) {
  return res.status(401).json({ 
    error: 'ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ - ุชู ุชุณุฌูู ุงูุฏุฎูู ูู ุฌูุงุฒ ุขุฎุฑ',
    code: 'SESSION_INVALID'
  });
}
```

#### ุฑููุฒ ุงูุฃุฎุทุงุก ุงูุฌุฏูุฏุฉ:
- `NO_AUTH_HEADER` - ูุง ููุฌุฏ header ูุตุงุฏูุฉ
- `SESSION_INVALID` - ุงูุฌูุณุฉ ุบูุฑ ุตุงูุญุฉ ุฃู ููุชููุฉ
- `USER_NOT_FOUND` - ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ
- `TOKEN_EXPIRED` - ุงูุชูุช ุตูุงุญูุฉ ุงูุชููู
- `INVALID_TOKEN` - ุชููู ุบูุฑ ุตุงูุญ

### 3. Routes ุงููุตุงุฏูุฉ (`server/src/routes/auth.ts`)

#### Endpoints ุฌุฏูุฏุฉ:

**POST `/api/auth/logout`**
- ุชุณุฌูู ุงูุฎุฑูุฌ ูุฅููุงุก ุงูุฌูุณุฉ ุงูุญุงููุฉ
- ูุชุทูุจ: Authentication

**GET `/api/auth/sessions`**
- ุนุฑุถ ุฌููุน ุงูุฌูุณุงุช ุงููุดุทุฉ ูููุณุชุฎุฏู
- ูุชุทูุจ: Authentication
- ูุฑุฌุน: ูุงุฆูุฉ ุงูุฌูุณุงุช ูุน ูุนูููุงุช ุงูุฌูุงุฒ ูุงูููุช

**POST `/api/auth/terminate-other-sessions`**
- ุฅููุงุก ุฌููุน ุงูุฌูุณุงุช ุงูุฃุฎุฑู ูุงุนุฏุง ุงูุญุงููุฉ
- ูุชุทูุจ: Authentication
- ูุฑุฌุน: ุนุฏุฏ ุงูุฌูุณุงุช ุงูุชู ุชู ุฅููุงุคูุง

#### ุชุนุฏููุงุช ุนูู Endpoints ุงูููุฌูุฏุฉ:

**POST `/api/auth/register`**
- ูููุดุฆ ุฌูุณุฉ ุชููุงุฆูุงู ุจุนุฏ ุงูุชุณุฌูู

**POST `/api/auth/login`**
- ูููุดุฆ ุฌูุณุฉ ุฌุฏูุฏุฉ ูููููู ุฌููุน ุงูุฌูุณุงุช ุงููุฏููุฉ ุชููุงุฆูุงู
- ูุญูุธ ูุนูููุงุช ุงูุฌูุงุฒ ูIP

**POST `/api/auth/quick-login`**
- ูููุดุฆ ุฌูุณุฉ ุฌุฏูุฏุฉ ูููููู ุงููุฏููุฉ

### 4. ุงูููุงู ุงูุฏูุฑูุฉ (`server/src/index.ts`)

#### ุชูุธูู ุงูุฌูุณุงุช ุงูููุชููุฉ
```typescript
// ูู ุณุงุนุฉ
cron.schedule('0 * * * *', async () => {
  const cleanedCount = cleanupExpiredSessions();
  console.log(`Cleaned up ${cleanedCount} expired sessions`);
});
```

## ููู ูุนูู ุงููุธุงู

### ุณููุงุฑูู 1: ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ
1. ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ูู ุงูุฌูุงุฒ A
2. ูุชู ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ ูุน token
3. ูุชู ุญูุธ ูุนูููุงุช ุงูุฌูุงุฒ ูIP
4. ุงูุฌูุณุฉ ุตุงูุญุฉ ููุฏุฉ 30 ููู

### ุณููุงุฑูู 2: ุชุณุฌูู ุฏุฎูู ูู ุฌูุงุฒ ุขุฎุฑ
1. ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ูู ุงูุฌูุงุฒ B
2. ุงููุธุงู ููููู ุงูุฌูุณุฉ ุงููุดุทุฉ ุนูู ุงูุฌูุงุฒ A ุชููุงุฆูุงู
3. ูุชู ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ ููุฌูุงุฒ B
4. ุงูุฌูุงุฒ A ูุญุตู ุนูู ุฎุทุฃ `SESSION_INVALID` ุนูุฏ ุงููุญุงููุฉ ุงูุชุงููุฉ

### ุณููุงุฑูู 3: ุงุณุชุฎุฏุงู ุงูุชุทุจูู
1. ูู ุทูุจ API ูุชุญูู ูู ุตูุงุญูุฉ ุงูุฌูุณุฉ
2. ุฅุฐุง ูุงูุช ุงูุฌูุณุฉ ุตุงูุญุฉุ ูุชู ุชุญุฏูุซ `last_activity`
3. ุฅุฐุง ูุงูุช ุงูุฌูุณุฉ ููุชููุฉ ุฃู ุบูุฑ ูุดุทุฉุ ูุชู ุฑูุถ ุงูุทูุจ
4. ุงููุณุชุฎุฏู ูุญุชุงุฌ ูุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู

### ุณููุงุฑูู 4: ุชุณุฌูู ุงูุฎุฑูุฌ
1. ุงููุณุชุฎุฏู ูุถุบุท ุนูู ุชุณุฌูู ุงูุฎุฑูุฌ
2. ูุชู ุฅููุงุก ุงูุฌูุณุฉ ุงูุญุงููุฉ
3. ุงูุชููู ูุตุจุญ ุบูุฑ ุตุงูุญ
4. ุงููุณุชุฎุฏู ูุญุชุงุฌ ูุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู

## ุงูุฃูุงู

### ุงูุญูุงูุฉ ูู:
- โ ุงุณุชุฎุฏุงู ุงูุญุณุงุจ ูู ุฃุฌูุฒุฉ ูุชุนุฏุฏุฉ
- โ ุณุฑูุฉ ุงูุชููู (ุงูุฌูุณุฉ ุชูููู ุนูุฏ ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ)
- โ ุงูุฌูุณุงุช ุงูููุชููุฉ (ุชูุธูู ุชููุงุฆู)
- โ ุงุณุชุฎุฏุงู ุชููู ูุฏูู (ุงูุชุญูู ูู ุงูุฌูุณุฉ)

### ูุนูููุงุช ุงูุชุชุจุน:
- ููุน ุงูุฌูุงุฒ
- ุนููุงู IP
- ููุช ุงูุฅูุดุงุก
- ุขุฎุฑ ูุดุงุท

## ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก ูู ุงูุชุทุจูู ุงููุญููู

### ุฎุทุฃ `SESSION_INVALID`
```typescript
if (error.code === 'SESSION_INVALID') {
  // ุฅููุงุก ุงูุฌูุณุฉ ุงููุญููุฉ
  await AsyncStorage.removeItem('token');
  
  // ุนุฑุถ ุฑุณุงูุฉ ูููุณุชุฎุฏู
  Alert.alert(
    'ุชู ุชุณุฌูู ุงูุฏุฎูู ูู ุฌูุงุฒ ุขุฎุฑ',
    'ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู',
    [{ text: 'ุญุณูุงู', onPress: () => navigation.navigate('Login') }]
  );
}
```

## ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ุฌูุณุฉ ูุงุญุฏุฉ
```bash
# ุชุณุฌูู ุฏุฎูู ูู ุงูุฌูุงุฒ ุงูุฃูู
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"123456"}'

# ุญูุธ ุงูุชููู ุงูุฃูู
TOKEN1="..."

# ุชุณุฌูู ุฏุฎูู ูู ุฌูุงุฒ ุซุงูู (ููุณ ุงูุญุณุงุจ)
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"123456"}'

# ุญูุธ ุงูุชููู ุงูุซุงูู
TOKEN2="..."

# ูุญุงููุฉ ุงุณุชุฎุฏุงู ุงูุชููู ุงูุฃูู (ูุฌุจ ุฃู ููุดู)
curl http://localhost:3001/api/auth/me \
  -H "Authorization: Bearer $TOKEN1"
# ุงููุชูุฌุฉ: SESSION_INVALID

# ุงุณุชุฎุฏุงู ุงูุชููู ุงูุซุงูู (ูุฌุจ ุฃู ููุฌุญ)
curl http://localhost:3001/api/auth/me \
  -H "Authorization: Bearer $TOKEN2"
# ุงููุชูุฌุฉ: ุจูุงูุงุช ุงููุณุชุฎุฏู
```

### 2. ุงุฎุชุจุงุฑ ุนุฑุถ ุงูุฌูุณุงุช
```bash
curl http://localhost:3001/api/auth/sessions \
  -H "Authorization: Bearer $TOKEN"
```

### 3. ุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุฎุฑูุฌ
```bash
curl -X POST http://localhost:3001/api/auth/logout \
  -H "Authorization: Bearer $TOKEN"
```

## ุงููููุงุช ุงููุนุฏูุฉ
1. `server/src/db/database.ts` - ุฅุถุงูุฉ ุฌุฏูู ูุฏูุงู ุงูุฌูุณุงุช
2. `server/src/middleware/auth.ts` - ุฅุถุงูุฉ ุงูุชุญูู ูู ุงูุฌูุณุฉ
3. `server/src/routes/auth.ts` - ุฅุถุงูุฉ endpoints ุงูุฌูุณุงุช
4. `server/src/index.ts` - ุฅุถุงูุฉ ูููุฉ ุชูุธูู ุงูุฌูุณุงุช

## ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงุฎุชูุงุฑู)

### ูู ุงูุชุทุจูู ุงููุญููู:
1. ูุนุงูุฌุฉ ุฎุทุฃ `SESSION_INVALID`
2. ุนุฑุถ ุฑุณุงูุฉ "ุชู ุชุณุฌูู ุงูุฏุฎูู ูู ุฌูุงุฒ ุขุฎุฑ"
3. ุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏู ูุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู
4. ุฅุถุงูุฉ ุดุงุดุฉ ูุนุฑุถ ุงูุฌูุณุงุช ุงููุดุทุฉ
5. ุฅุถุงูุฉ ุฒุฑ ูุฅููุงุก ุงูุฌูุณุงุช ุงูุฃุฎุฑู

### ููุฒุงุช ุฅุถุงููุฉ:
- ุฅุดุนุงุฑ ุนูุฏ ุชุณุฌูู ุฏุฎูู ูู ุฌูุงุฒ ุฌุฏูุฏ
- ุณุฌู ุชุงุฑูุฎ ุงูุฌูุณุงุช
- ุญุธุฑ ุงูุฃุฌูุฒุฉ ุงููุดุจููุฉ
- ุชูุนูู ุงููุตุงุฏูุฉ ุงูุซูุงุฆูุฉ

ุชู ุงูุชูููุฐ ุจูุฌุงุญ! ๐
