# 🔄 مخطط تدفق نظام التحليل الذكي

## المخطط العام للنظام

```
┌─────────────────────────────────────────────────────────────────┐
│                    🎯 نظام التحليل التلقائي                     │
│                   يعمل كل 5 دقائق (إغلاق شمعة M5)               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      المرحلة 1: جلب البيانات                    │
├─────────────────────────────────────────────────────────────────┤
│  📊 OANDA API                                                   │
│  ├─→ H1 Candles (100 شمعة)                                     │
│  ├─→ M5 Candles (140 شمعة)                                     │
│  └─→ Current Price                                              │
│                                                                 │
│  ملف: server/src/services/oandaService.ts                      │
│  دوال: getCandles(), getCurrentPrice()                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      المرحلة 2: رسم الشارتات                    │
├─────────────────────────────────────────────────────────────────┤
│  🎨 Puppeteer + Canvas                                          │
│  ├─→ H1 Chart (صورة PNG)                                       │
│  └─→ M5 Chart (صورة PNG)                                       │
│                                                                 │
│  ملف: server/src/services/chartService.ts                      │
│       server/src/services/screenshotService.ts                 │
│  دالة: renderDualCharts()                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   المرحلة 3: التحليل بالـ AI                     │
├─────────────────────────────────────────────────────────────────┤
│  🤖 Vision AI Model (llama3.2-vision)                           │
│  ← H1 Image                                                     │
│  ← M5 Image                                                     │
│  ← Current Price                                                │
│  ← Candles Data                                                 │
│  ← ICT System Instructions (500+ سطر)                          │
│                                                                 │
│  ملف: server/src/services/aiService.ts                         │
│  دالة: analyzeMultiTimeframe()                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                   ┌──────────────────┐
                   │  تحليل الشروط    │
                   └──────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                                           ↓
┌──────────────────┐                    ┌──────────────────┐
│ الشرط 0:         │                    │ الشرط 1:         │
│ توافق H1         │                    │ سحب السيولة      │
├──────────────────┤                    ├──────────────────┤
│ ✅ H1 صاعد →     │                    │ ✅ SSL Sweep     │
│    شراء فقط      │                    │ ✅ BSL Sweep     │
│ ✅ H1 هابط →     │                    │ ❌ لا يوجد      │
│    بيع فقط       │                    │    → NO_TRADE    │
│ ⚠️ H1 محايد →    │                    └──────────────────┘
│    حذر شديد      │
└──────────────────┘
        ↓
┌──────────────────────────────────────────────────────────────┐
│              الشرط 2: كسر الهيكل (MSS/CHoCH)                 │
├──────────────────────────────────────────────────────────────┤
│ ✅ MSS بعد السحب                                             │
│ ✅ CHoCH بعد السحب                                           │
│ ❌ لم يحدث كسر → NO_TRADE                                    │
└──────────────────────────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────────────────────────┐
│              الشرط 3: الإزاحة السعرية (Displacement)         │
├──────────────────────────────────────────────────────────────┤
│ ✅ STRONG: حركة قوية جداً                                    │
│ ✅ MODERATE: حركة متوسطة                                     │
│ ❌ WEAK: حركة ضعيفة → NO_TRADE                               │
└──────────────────────────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────────────────────────┐
│              الشرط 4: منطقة الدخول (PD Array)                │
├──────────────────────────────────────────────────────────────┤
│ ✅ Order Block (OB) قوي                                      │
│ ✅ Fair Value Gap (FVG)                                       │
│ ✅ FVG في OB (الأفضل)                                        │
│ ❌ لا يوجد → NO_TRADE                                        │
└──────────────────────────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────────────────────────┐
│              الشرط 5: الموقع السعري                          │
├──────────────────────────────────────────────────────────────┤
│ ✅ BUY في Discount (< 50%)                                   │
│ ✅ SELL في Premium (> 50%)                                   │
│ ⚠️ MID → تخفيض التقييم                                       │
│ ❌ معاكس → NO_TRADE                                          │
└──────────────────────────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────────────────────────┐
│              الشرط 6: جلسات التداول (Killzone)               │
├──────────────────────────────────────────────────────────────┤
│ 🟢 HIGH: لندن (7-10 UTC), نيويورك AM (12-15 UTC)            │
│ 🟡 MEDIUM: آسيا (0-3 UTC), نيويورك PM (15-18 UTC)           │
│ 🔴 LOW: خارج الأوقات → تحذير (لا رفض)                        │
└──────────────────────────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────────────────────────┐
│              الشرط 7: صحة سعر الدخول                         │
├──────────────────────────────────────────────────────────────┤
│ ✅ BUY_LIMIT: Entry < Current Price                          │
│ ✅ SELL_LIMIT: Entry > Current Price                         │
│ ❌ انتهاك → رفض فوري                                         │
└──────────────────────────────────────────────────────────────┘
                              ↓
               ┌──────────────────────────┐
               │   هل تحققت كل الشروط؟    │
               └──────────────────────────┘
                      ↓          ↓
                     نعم        لا
                      ↓          ↓
        ┌──────────────────┐  ┌──────────────────┐
        │  حساب الصفقة     │  │   NO_TRADE       │
        └──────────────────┘  └──────────────────┘
                ↓                      ↓
┌───────────────────────────┐  ┌───────────────────────────┐
│     حساب نقاط الدخول      │  │   reasons: أسباب الرفض    │
├───────────────────────────┤  │   - لم يحدث سحب سيولة    │
│ Entry: منتصف FVG/OB      │  │   - لم يتم كسر الهيكل     │
│ SL: تحت/فوق المنطقة      │  │   - الموقع السعري خاطئ    │
│ TP1: 40% من الهدف        │  └───────────────────────────┘
│ TP2: 70% من الهدف        │
│ TP3: 100% من الهدف       │
│ RR: حساب النسبة          │
└───────────────────────────┘
                ↓
┌───────────────────────────────────────────────────────────────┐
│                  حساب Score و Confidence                      │
├───────────────────────────────────────────────────────────────┤
│  Score (0-10):                                                │
│  ├─ قوة OB: +2                                                │
│  ├─ قوة Displacement: +2                                      │
│  ├─ توافق H1: +1                                              │
│  ├─ جودة Killzone: +1                                         │
│  ├─ RR Ratio: +1                                              │
│  ├─ Confluences: +1                                           │
│  └─ FVG في OB: +1                                             │
│                                                               │
│  Confidence (0-100):                                          │
│  ├─ Score × 10 (قاعدة)                                       │
│  ├─ قوة السحب: +10%                                          │
│  ├─ قوة MSS: +10%                                             │
│  ├─ جودة OB: +10%                                             │
│  └─ خصومات حسب الحاجة                                        │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌───────────────────────────────────────────────────────────────┐
│                   المرحلة 4: التحقق النهائي                   │
├───────────────────────────────────────────────────────────────┤
│  ✅ Score >= 6.0?                                             │
│  ✅ Confidence >= 65%?                                        │
│  ✅ RR >= 1.8?                                                │
│  ✅ Distance <= 1.2%?                                         │
│  ✅ Confluences >= 2?                                         │
│                                                               │
│  ملف: server/src/services/aiService.ts                       │
│  المتغير: VALIDATION_OPTIONS                                 │
└───────────────────────────────────────────────────────────────┘
                              ↓
               ┌──────────────────────────┐
               │    هل مر التحقق؟         │
               └──────────────────────────┘
                      ↓          ↓
                     نعم        لا
                      ↓          ↓
        ┌──────────────────┐  ┌──────────────────┐
        │  PLACE_PENDING   │  │   NO_TRADE       │
        └──────────────────┘  └──────────────────┘
                ↓                      ↓
┌───────────────────────────┐  ┌───────────────────────────┐
│    النتيجة النهائية      │  │     النتيجة النهائية      │
├───────────────────────────┤  ├───────────────────────────┤
│ {                         │  │ {                         │
│   decision: "PLACE_PENDING"│ │   decision: "NO_TRADE",   │
│   score: 8.5,             │  │   score: 3.0,             │
│   confidence: 85,         │  │   confidence: 25,         │
│   suggestedTrade: {       │  │   reasons: [...]          │
│     type: "BUY_LIMIT",    │  │ }                         │
│     entry: 2645.50,       │  │                           │
│     sl: 2640.00,          │  │                           │
│     tp1: 2650.00,         │  │                           │
│     tp2: 2655.00,         │  │                           │
│     tp3: 2660.00          │  │                           │
│   },                      │  │                           │
│   confluences: [...],     │  │                           │
│   reasoning: "..."        │  │                           │
│ }                         │  │                           │
└───────────────────────────┘  └───────────────────────────┘
                ↓                      ↓
┌───────────────────────────────────────────────────────────────┐
│               المرحلة 5: الحفظ في قاعدة البيانات              │
├───────────────────────────────────────────────────────────────┤
│  💾 لكل مستخدم مفعّل التحليل التلقائي:                       │
│  ├─→ enhanced_analysis table                                  │
│  │   ├─ analysis_type: 'auto'                                 │
│  │   ├─ user_id: معرف المستخدم                               │
│  │   ├─ decision, score, confidence                           │
│  │   └─ suggested_trade, reasoning                            │
│  │                                                             │
│  └─→ auto_analysis table (للتوافق)                            │
│                                                                │
│  ملف: server/src/db/postgresOperations.ts                     │
│  دالة: saveEnhancedAnalysis()                                 │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌───────────────────────────────────────────────────────────────┐
│                   المرحلة 6: إرسال الإشعارات                  │
└───────────────────────────────────────────────────────────────┘
        ↓                                     ↓
┌─────────────────────┐            ┌─────────────────────┐
│   إذا وجدت صفقة     │            │  إذا لم توجد صفقة   │
├─────────────────────┤            ├─────────────────────┤
│ 📱 Telegram Bot     │            │ 📋 سجل فقط          │
│    للمشتركين        │            │    (لا إشعارات)     │
│                     │            │                     │
│ 📱 Push Notification│            │ ⚠️ إذا كان خطأ      │
│    للتطبيق          │            │    → إشعار إداري    │
│                     │            │                     │
│ 📧 Email (اختياري)  │            └─────────────────────┘
│                     │
│ رسالة تحتوي:        │
│ ├─ نوع الصفقة       │
│ ├─ نقاط الدخول      │
│ ├─ الأهداف          │
│ ├─ RR Ratio         │
│ ├─ التقييم والثقة   │
│ └─ التحليل المفصل   │
└─────────────────────┘
        ↓
┌───────────────────────────────────────────────────────────────┐
│                المرحلة 7: جدولة التحليل القادم                │
├───────────────────────────────────────────────────────────────┤
│  ⏰ حساب وقت إغلاق الشمعة القادمة                            │
│  ↓                                                            │
│  انتظار حتى إغلاق M5 القادم                                  │
│  ↓                                                            │
│  تكرار الدورة (العودة للمرحلة 1)                             │
│                                                               │
│  ملف: server/src/index.ts                                    │
│  دوال: scheduleNextAnalysis(), runAutoAnalysis()             │
└───────────────────────────────────────────────────────────────┘
```

---

## مخطط تفصيلي لتحليل الشروط

```
                  🔍 تحليل الشروط السبعة
                           ↓
    ┌──────────────────────┴──────────────────────┐
    ↓                                             ↓
┌─────────────────────┐               ┌─────────────────────┐
│   تحليل H1          │               │   تحليل M5          │
├─────────────────────┤               ├─────────────────────┤
│ 1. تحديد الاتجاه    │               │ 1. البحث عن Sweep   │
│    ├─ Higher Highs? │               │    محلي             │
│    ├─ Higher Lows?  │               │ 2. البحث عن MSS     │
│    └─ القرار:       │               │ 3. تحديد            │
│       BULLISH/      │               │    Displacement     │
│       BEARISH/      │               │ 4. تحديد FVG/OB     │
│       NEUTRAL       │               │ 5. حساب Entry       │
│                     │               │ 6. حساب SL/TP       │
│ 2. البحث عن Sweep  │               └─────────────────────┘
│    ├─ BSL Sweep?    │                          ↓
│    ├─ SSL Sweep?    │                  ┌───────────────┐
│    └─ Evidence:     │                  │  دمج التحليل  │
│       • Wick        │                  │   من H1 و M5  │
│       • Close back  │                  └───────────────┘
│       • Reversal    │                          ↓
│                     │               ┌─────────────────────┐
│ 3. تحديد السيولة   │               │  حساب Score         │
│    القادمة          │               ├─────────────────────┤
│    ├─ Nearest BSL   │               │ ✅ كل شرط متحقق    │
│    └─ Nearest SSL   │               │    → +1 أو +2      │
│                     │               │ ❌ شرط غير متحقق   │
│ 4. حساب النطاق     │               │    → رفض أو خصم    │
│    ├─ High: ؟       │               └─────────────────────┘
│    ├─ Low: ؟        │                          ↓
│    ├─ 50%: ؟        │               ┌─────────────────────┐
│    └─ Current: ؟    │               │ حساب Confidence    │
│       Premium?      │               ├─────────────────────┤
│       Discount?     │               │ Base: Score × 10    │
│                     │               │ + قوة السحب        │
│ 5. تحديد Killzone  │               │ + قوة MSS           │
│    ├─ Session: ؟    │               │ + جودة OB           │
│    ├─ Quality: ؟    │               │ - خصومات            │
│    └─ Active?: ؟    │               └─────────────────────┘
└─────────────────────┘
```

---

## مخطط معالجة الأخطاء

```
┌───────────────────────────────────────────────────────────────┐
│                    🔄 معالجة الأخطاء                          │
└───────────────────────────────────────────────────────────────┘
                              ↓
                ┌─────────────────────────┐
                │  جلب البيانات من OANDA  │
                └─────────────────────────┘
                              ↓
                    ┌─────────┴─────────┐
                    ↓                   ↓
            ┌──────────────┐    ┌──────────────┐
            │   نجح        │    │   فشل        │
            └──────────────┘    └──────────────┘
                    ↓                   ↓
            ┌──────────────┐    ┌──────────────────────┐
            │ متابعة       │    │ المحاولة 1:          │
            │ التحليل      │    │ انتظار 2 ثانية      │
            └──────────────┘    │ ثم إعادة المحاولة    │
                                └──────────────────────┘
                                        ↓
                              ┌─────────┴─────────┐
                              ↓                   ↓
                      ┌──────────────┐    ┌──────────────┐
                      │   نجح        │    │   فشل        │
                      └──────────────┘    └──────────────┘
                              ↓                   ↓
                      ┌──────────────┐    ┌──────────────────────┐
                      │ متابعة       │    │ المحاولة 2:          │
                      │ التحليل      │    │ انتظار 4 ثوان       │
                      └──────────────┘    │ ثم إعادة المحاولة    │
                                          └──────────────────────┘
                                                  ↓
                                        ┌─────────┴─────────┐
                                        ↓                   ↓
                                ┌──────────────┐    ┌──────────────┐
                                │   نجح        │    │   فشل        │
                                └──────────────┘    └──────────────┘
                                        ↓                   ↓
                                ┌──────────────┐    ┌──────────────────────┐
                                │ متابعة       │    │ المحاولة 3:          │
                                │ التحليل      │    │ انتظار 6 ثوان       │
                                └──────────────┘    │ ثم إعادة المحاولة    │
                                                    └──────────────────────┘
                                                            ↓
                                                  ┌─────────┴─────────┐
                                                  ↓                   ↓
                                          ┌──────────────┐    ┌──────────────┐
                                          │   نجح        │    │ فشل نهائي    │
                                          └──────────────┘    └──────────────┘
                                                  ↓                   ↓
                                          ┌──────────────┐    ┌──────────────────┐
                                          │ متابعة       │    │ ❌ تجاوز هذه    │
                                          │ التحليل      │    │    الدورة       │
                                          └──────────────┘    │ 📧 إشعار إداري  │
                                                              │ ⏰ انتظار الدورة│
                                                              │    القادمة       │
                                                              └──────────────────┘
```

---

## مخطط تدفق البيانات

```
┌─────────────────────────────────────────────────────────────────┐
│                        OANDA API                                │
│              مصدر البيانات الأساسي                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┼─────────────────────┐
        ↓                     ↓                     ↓
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ H1 Candles   │    │ M5 Candles   │    │ Current Price│
│ (100)        │    │ (140)        │    │              │
└──────────────┘    └──────────────┘    └──────────────┘
        ↓                     ↓                     ↓
        └─────────────────────┼─────────────────────┘
                              ↓
                    ┌──────────────────┐
                    │  Chart Service   │
                    │ (رسم الشارتات)   │
                    └──────────────────┘
                              ↓
        ┌─────────────────────┼─────────────────────┐
        ↓                                           ↓
┌──────────────────┐                    ┌──────────────────┐
│ H1 Image (PNG)   │                    │ M5 Image (PNG)   │
│ Base64 Encoded   │                    │ Base64 Encoded   │
└──────────────────┘                    └──────────────────┘
        ↓                                           ↓
        └─────────────────────┬─────────────────────┘
                              ↓
                    ┌──────────────────┐
                    │   AI Service     │
                    │ (Vision Model)   │
                    │ + ICT Rules      │
                    └──────────────────┘
                              ↓
                    ┌──────────────────┐
                    │  Analysis Result │
                    │     (JSON)       │
                    └──────────────────┘
                              ↓
        ┌─────────────────────┼─────────────────────┐
        ↓                     ↓                     ↓
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Database   │    │ Notifications│    │  API Response│
│ (PostgreSQL) │    │  (Telegram   │    │  (للتطبيق)   │
│              │    │   + Push)    │    │              │
└──────────────┘    └──────────────┘    └──────────────┘
```

---

## مخطط الاشتراكات والأذونات

```
┌─────────────────────────────────────────────────────────────────┐
│                      👤 المستخدم (User)                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                ┌─────────────┴─────────────┐
                ↓                           ↓
        ┌──────────────┐            ┌──────────────┐
        │ لديه اشتراك؟ │            │ زائر/مجاني   │
        └──────────────┘            └──────────────┘
                ↓                           ↓
        ┌──────────────────┐        ┌──────────────────┐
        │ نعم - تحقق من   │        │ ✅ سجل التحليلات │
        │ نوع الاشتراك    │        │    (مجاني)       │
        └──────────────────┘        │ ✅ عرض السعر     │
                ↓                   │    (مجاني)       │
    ┌───────────┴───────────┐       │ ❌ التحليل       │
    ↓                       ↓       │    التلقائي      │
┌──────────┐        ┌──────────┐    │ ❌ المحادثة مع   │
│ FREE     │        │ PAID     │    │    AI            │
│ (مجاني)  │        │ (مدفوع)  │    │ ❌ متابعة الصفقة │
└──────────┘        └──────────┘    └──────────────────┘
    ↓                       ↓
┌──────────────┐    ┌──────────────────────┐
│ الأذونات:    │    │ الأذونات:            │
│ ✅ السجل     │    │ ✅ كل شيء             │
│ ✅ السعر     │    │ ✅ التحليل التلقائي  │
│ ❌ التحليل   │    │    (إذا مفعّل)        │
│    التلقائي  │    │ ✅ المحادثة مع AI    │
│ ❌ AI Chat   │    │ ✅ متابعة الصفقة     │
│ ❌ Follow-up │    │ ✅ سجل كامل           │
└──────────────┘    └──────────────────────┘
                            ↓
                    ┌──────────────────┐
                    │ التحليل التلقائي │
                    │   مفعّل؟         │
                    └──────────────────┘
                            ↓
                    ┌───────┴───────┐
                    ↓               ↓
            ┌──────────┐    ┌──────────┐
            │ نعم      │    │ لا       │
            └──────────┘    └──────────┘
                    ↓               ↓
        ┌──────────────────┐  ┌──────────────────┐
        │ 📱 يستقبل إشعار  │  │ ❌ لا يستقبل    │
        │    تلقائياً      │  │    إشعارات      │
        │                  │  │                  │
        │ 💾 يُحفظ له      │  │ 💾 لا يُحفظ له  │
        │    التحليل       │  │    التحليل       │
        └──────────────────┘  └──────────────────┘
```

---

## الخلاصة

هذه المخططات توضح:
1. ✅ **التدفق الكامل** من جلب البيانات حتى الإشعارات
2. ✅ **الشروط السبعة** وكيفية فحصها
3. ✅ **معالجة الأخطاء** والمحاولات المتكررة
4. ✅ **تدفق البيانات** بين الخدمات المختلفة
5. ✅ **نظام الاشتراكات** والأذونات

**للمزيد من التفاصيل:**
راجع ملف `شرح_نظام_التحليل_AI.md`
